name: Mayor West Auto-Merge
# Autonomous PR merge workflow with 4-layer security architecture
# Layer 1: Actor allowlist (CODEOWNERS)
# Layer 2: Protected paths check (mayor-west.yml)
# Layer 3: Kill switch (enabled flag)
# Layer 4: Audit trail (PR comments)
#
# IMPORTANT: Uses pull_request_target to run in base repo context
# This avoids "first-time contributor" approval requirements for Copilot PRs
# Security is maintained through our 4-layer checks (CODEOWNERS, protected paths, etc.)

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Layer 1: Only run for Copilot PRs (copilot-swe-agent is the GitHub App actor)
    if: github.actor == 'copilot-swe-agent' || github.actor == 'copilot' || github.actor == 'copilot[bot]'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For pull_request_target, we need to checkout the PR head
          ref: ${{ github.event.pull_request.head.sha }}
          sparse-checkout: |
            .github/mayor-west.yml
            .github/CODEOWNERS

      - name: Check Security Layers
        id: security
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // ================================================================
            // Layer 1: Check if actor is in CODEOWNERS allowlist
            // ================================================================
            let actorAllowed = false;
            const codeownersPath = '.github/CODEOWNERS';
            
            if (fs.existsSync(codeownersPath)) {
              const codeowners = fs.readFileSync(codeownersPath, 'utf8');
              const actor = context.actor;
              // Check if actor (copilot, copilot[bot]) is mentioned
              actorAllowed = codeowners.includes('@' + actor) || 
                             codeowners.includes('@copilot');
              console.log(`Layer 1 - CODEOWNERS check: ${actorAllowed ? 'âœ… PASS' : 'âŒ FAIL'}`);
              console.log(`  Actor: ${actor}`);
            } else {
              // No CODEOWNERS = allow all (backwards compatibility)
              actorAllowed = true;
              console.log('Layer 1 - CODEOWNERS: âš ï¸ No file found, allowing all actors');
            }
            
            if (!actorAllowed) {
              core.setOutput('allowed', 'false');
              core.setOutput('reason', 'Actor not in CODEOWNERS allowlist');
              return;
            }
            
            // ================================================================
            // Layer 2: Check protected paths
            // ================================================================
            const configPath = '.github/mayor-west.yml';
            let config = { enabled: true, protected_paths: [] };
            
            if (fs.existsSync(configPath)) {
              const yaml = fs.readFileSync(configPath, 'utf8');
              // Simple YAML parsing for our known structure
              const enabledMatch = yaml.match(/^enabled:\s*(true|false)/m);
              if (enabledMatch) {
                config.enabled = enabledMatch[1] === 'true';
              }
              
              // Extract protected_paths array
              const pathsMatch = yaml.match(/protected_paths:\s*\n([\s\S]*?)(?=\n[a-z]|$)/);
              if (pathsMatch) {
                const pathLines = pathsMatch[1].split('\n');
                config.protected_paths = pathLines
                  .filter(line => line.trim().startsWith('-'))
                  .map(line => line.replace(/^\s*-\s*["']?([^"'#]+)["']?.*$/, '$1').trim())
                  .filter(p => p.length > 0);
              }
            }
            
            // ================================================================
            // Layer 3: Kill switch check
            // ================================================================
            if (!config.enabled) {
              console.log('Layer 3 - Kill switch: âŒ Mayor West Mode is PAUSED');
              core.setOutput('allowed', 'false');
              core.setOutput('reason', 'Mayor West Mode is paused (enabled: false)');
              return;
            }
            console.log('Layer 3 - Kill switch: âœ… Mode is ENABLED');
            
            // ================================================================
            // Layer 2 continued: Check if PR touches protected paths
            // ================================================================
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const changedFiles = files.map(f => f.filename);
            console.log(`Changed files: ${changedFiles.join(', ')}`);
            
            // Glob pattern matching
            function matchesGlob(filepath, pattern) {
              // Convert glob to regex
              let regex = pattern
                .replace(/\./g, '\\.')
                .replace(/\*\*/g, '<<<DOUBLESTAR>>>')
                .replace(/\*/g, '[^/]*')
                .replace(/<<<DOUBLESTAR>>>/g, '.*');
              return new RegExp('^' + regex + '$').test(filepath);
            }
            
            const protectedHits = [];
            for (const file of changedFiles) {
              for (const pattern of config.protected_paths) {
                if (matchesGlob(file, pattern)) {
                  protectedHits.push({ file, pattern });
                }
              }
            }
            
            if (protectedHits.length > 0) {
              console.log('Layer 2 - Protected paths: âŒ BLOCKED');
              for (const hit of protectedHits) {
                console.log(`  ${hit.file} matches ${hit.pattern}`);
              }
              core.setOutput('allowed', 'false');
              core.setOutput('reason', 'PR touches protected paths: ' + protectedHits.map(h => h.file).join(', '));
              core.setOutput('protected_files', protectedHits.map(h => h.file).join(', '));
              return;
            }
            console.log('Layer 2 - Protected paths: âœ… No protected files touched');
            
            // All checks passed
            console.log('\nâœ… All security layers passed - auto-merge allowed');
            core.setOutput('allowed', 'true');

      - name: Add Protected Path Comment
        if: steps.security.outputs.allowed == 'false' && steps.security.outputs.protected_files != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ›¡ï¸ Mayor West Security Check
            
            **Auto-merge disabled** - This PR touches protected paths.
            
            **Protected files:**
            ${'${{ steps.security.outputs.protected_files }}'.split(', ').map(f => '- \`' + f + '\`').join('\n')}
            
            A human must review and merge this PR manually.
            
            ---
            *Mayor West Mode - Security Layer 2 (Protected Paths)*`
            });

      - name: Mark PR Ready and Enable Auto-Merge
        if: steps.security.outputs.allowed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNodeId = context.payload.pull_request.node_id;
            const prNumber = context.issue.number;
            
            // Step 1: Mark PR as ready (in case it's a draft)
            if (context.payload.pull_request.draft) {
              console.log('ðŸ“ PR is a draft, marking as ready for review...');
              try {
                await github.graphql(`
                  mutation {
                    markPullRequestReadyForReview(input: {
                      pullRequestId: "${prNodeId}"
                    }) {
                      pullRequest {
                        isDraft
                      }
                    }
                  }
                `);
                console.log('âœ… PR marked as ready for review');
              } catch (error) {
                console.log('âš ï¸ Could not mark PR as ready:', error.message);
              }
            }
            
            // Step 2: Enable auto-merge
            try {
              await github.graphql(`
                mutation {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: "${prNodeId}"
                    mergeMethod: SQUASH
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `);
              
              // Layer 4: Audit trail
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ðŸ¤– Mayor West Auto-Merge Enabled
              
            âœ… All security checks passed:
            - **Layer 1**: Actor in CODEOWNERS allowlist
            - **Layer 2**: No protected paths touched  
            - **Layer 3**: Mode enabled
            
            This PR will merge automatically when all status checks pass.
            
            ---
            *Mayor West Mode v1.0.0*`
              });
              
              console.log('âœ… Auto-merge enabled for PR #' + prNumber);
            } catch (error) {
              console.log('âš ï¸ Auto-merge could not be enabled:', error.message);
              console.log('Ensure "Allow auto-merge" is enabled in repository settings.');
            }

      - name: Skip Auto-Merge
        if: steps.security.outputs.allowed == 'false' && steps.security.outputs.protected_files == ''
        run: |
          echo "âš ï¸ Auto-merge skipped: ${{ steps.security.outputs.reason }}"
